{% extends "layouts/base.html" %}

{% block style %}
<style>
    .table-container {
        margin-top: 20px;
        overflow-x: auto;
    }
    .tab-content {
        padding: 20px;
        border: 1px solid #dee2e6;
        border-top: none;
        background: white;
    }
    .edit-input {
        width: 100%;
        padding: 5px;
    }
    .btn-sm {
        margin: 2px;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Database Admin Panel</h1>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="tableTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="survey-responses-tab" data-bs-toggle="tab" data-bs-target="#survey-responses" type="button">Survey Responses</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-preferences-tab" data-bs-toggle="tab" data-bs-target="#ai-preferences" type="button">AI Tool Preferences</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button">Questions</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="leaderboard-tab" data-bs-toggle="tab" data-bs-target="#leaderboard" type="button">Leaderboard</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="submodule-feedback-tab" data-bs-toggle="tab" data-bs-target="#submodule-feedback" type="button">Submodule Feedback</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="badges-tab" data-bs-toggle="tab" data-bs-target="#badges" type="button">Badges</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="user-badges-tab" data-bs-toggle="tab" data-bs-target="#user-badges" type="button">User Badges</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="tableTabsContent">

        <!-- Survey Responses Tab -->
        <div class="tab-pane fade show active" id="survey-responses" role="tabpanel">
            <h3>Survey Responses <small class="text-muted">(100 rows)</small></h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="surveyResponsesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Uses AI for Schoolwork</th>
                            <th>Policy Perspective</th>
                            <th>Completed At</th>
                            <th>Badge Awarded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="surveyResponsesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Tool Preferences Tab -->
        <div class="tab-pane fade" id="ai-preferences" role="tabpanel">
            <h3>AI Tool Preferences <small class="text-muted">(100 rows)</small></h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="aiPreferencesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>AI Tool Preferences</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="aiPreferencesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Questions Tab -->
        <div class="tab-pane fade" id="questions" role="tabpanel">
            <h3>Questions Database</h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="questionsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Subject</th>
                            <th>Category</th>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="questionsBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div class="tab-pane fade" id="leaderboard" role="tabpanel">
            <h3>Game Leaderboard (Submodule 3)</h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="leaderboardTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Rank</th>
                            <th>ID</th>
                            <th>UID</th>
                            <th>Player Name</th>
                            <th>Score</th>
                            <th>Correct Answers</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Submodule Feedback Tab -->
        <div class="tab-pane fade" id="submodule-feedback" role="tabpanel">
            <h3>Submodule Feedback <span id="feedbackStats" class="text-muted small"></span></h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="submoduleFeedbackTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Rating</th>
                            <th>Category</th>
                            <th>Comments</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submoduleFeedbackBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Badges Tab -->
        <div class="tab-pane fade" id="badges" role="tabpanel">
            <h3>Badge Definitions</h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="badgesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Requirement</th>
                            <th>Image URL</th>
                            <th>Users</th>
                        </tr>
                    </thead>
                    <tbody id="badgesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Badges Tab (pivoted by user) -->
        <div class="tab-pane fade" id="user-badges" role="tabpanel">
            <h3>User Badges</h3>
            <div class="table-container">
                <table class="table table-striped table-hover" id="userBadgesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>User ID</th>
                            <th>UID</th>
                            <th>Username</th>
                            <th>Badges</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userBadgesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <h5>Grant Badge</h5>
                <div class="row">
                    <div class="col-md-3">
                        <input id="grant-uid" class="form-control" placeholder="User UID (e.g., toby)">
                    </div>
                    <div class="col-md-3">
                        <input id="grant-badge-id" class="form-control" placeholder="Badge ID (e.g., delightful_data_scientist)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary" onclick="grantBadge()">Grant Badge</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Edit Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Form fields populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/admin';
    let currentEditTable = '';
    let currentEditId = null;
    let currentEditData = null;

    // Load all data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSurveyResponses();
        loadAIPreferences();
        loadQuestions();
        loadLeaderboard();
        loadSubmoduleFeedback();
        loadBadges();
        loadUserBadges();
    });

    // ========== Survey Responses ==========
    async function loadSurveyResponses() {
        try {
            const response = await fetch(`${API_BASE}/survey-responses-with-users?limit=100`);
            const data = await response.json();
            const tbody = document.getElementById('surveyResponsesBody');
            tbody.innerHTML = data.map(resp => `
                <tr id="survey-response-${resp.id}">
                    <td>${resp.id}</td>
                    <td>${resp.user_id}</td>
                    <td>${resp.username || 'N/A'}</td>
                    <td>${resp.uses_ai_schoolwork}</td>
                    <td title="${resp.policy_perspective || ''}">${(resp.policy_perspective || '').substring(0, 50)}...</td>
                    <td>${resp.completed_at || 'N/A'}</td>
                    <td>${resp.badge_awarded ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editSurveyResponse(${resp.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSurveyResponse(${resp.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            $('#surveyResponsesTable').DataTable();
        } catch (error) {
            console.error('Error loading survey responses:', error);
        }
    }

    function editSurveyResponse(id) {
        currentEditTable = 'survey-responses';
        currentEditId = id;
        fetch(`${API_BASE}/survey-responses/${id}`).then(r => r.json()).then(resp => {
            document.getElementById('editModalTitle').textContent = 'Edit Survey Response';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Uses AI for Schoolwork</label>
                    <select class="form-control" id="edit-uses-ai">
                        <option value="Yes" ${resp.uses_ai_schoolwork === 'Yes' ? 'selected' : ''}>Yes</option>
                        <option value="No" ${resp.uses_ai_schoolwork === 'No' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Policy Perspective</label>
                    <textarea class="form-control" id="edit-policy" rows="4">${resp.policy_perspective || ''}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Badge Awarded</label>
                    <select class="form-control" id="edit-badge">
                        <option value="true" ${resp.badge_awarded ? 'selected' : ''}>Yes</option>
                        <option value="false" ${!resp.badge_awarded ? 'selected' : ''}>No</option>
                    </select>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    }

    async function deleteSurveyResponse(id) {
        if (!confirm('Are you sure you want to delete this survey response?')) return;
        try {
            await fetch(`${API_BASE}/survey-responses/${id}`, { method: 'DELETE' });
            loadSurveyResponses();
        } catch (error) {
            alert('Error deleting survey response');
        }
    }

    // ========== AI Tool Preferences (Grouped by User) ==========
    async function loadAIPreferences() {
        try {
            const response = await fetch(`${API_BASE}/ai-preferences-grouped?limit=100`);
            const data = await response.json();
            const tbody = document.getElementById('aiPreferencesBody');
            tbody.innerHTML = data.map(user => `
                <tr id="ai-pref-user-${user.user_id}">
                    <td>${user.user_id}</td>
                    <td>${user.username}</td>
                    <td>${user.preferences}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editAIPreferences(${user.user_id}, '${user.username}')">Edit</button>
                    </td>
                </tr>
            `).join('');
            $('#aiPreferencesTable').DataTable();
        } catch (error) {
            console.error('Error loading AI preferences:', error);
        }
    }

    function editAIPreferences(userId, username) {
        currentEditTable = 'ai-preferences-grouped';
        currentEditId = userId;
        fetch(`${API_BASE}/ai-preferences-by-user/${userId}`).then(r => r.json()).then(prefs => {
            currentEditData = prefs;
            const subjects = ['math', 'english', 'science', 'cs', 'history'];
            const tools = ['ChatGPT', 'Claude', 'Gemini', 'Copilot'];

            let formHtml = `<p><strong>User:</strong> ${username}</p>`;
            subjects.forEach(subject => {
                const currentTool = prefs.find(p => p.subject === subject)?.ai_tool || '';
                formHtml += `
                    <div class="mb-3">
                        <label class="form-label">${subject.charAt(0).toUpperCase() + subject.slice(1)}</label>
                        <select class="form-control" id="edit-pref-${subject}">
                            <option value="">-- Select --</option>
                            ${tools.map(tool => `<option value="${tool}" ${currentTool === tool ? 'selected' : ''}>${tool}</option>`).join('')}
                        </select>
                    </div>
                `;
            });

            document.getElementById('editModalTitle').textContent = 'Edit AI Tool Preferences';
            document.getElementById('editModalBody').innerHTML = formHtml;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    }

    // ========== Questions ==========
    async function loadQuestions() {
        try {
            const response = await fetch(`${API_BASE}/questions`);
            const data = await response.json();
            const tbody = document.getElementById('questionsBody');
            tbody.innerHTML = data.map(q => `
                <tr id="question-${q.id}">
                    <td>${q.id}</td>
                    <td>${q.subject}</td>
                    <td>${q.category}</td>
                    <td title="${q.question}">${q.question.substring(0, 50)}...</td>
                    <td title="${q.answer}">${q.answer.substring(0, 30)}...</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editQuestion(${q.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            $('#questionsTable').DataTable();
        } catch (error) {
            console.error('Error loading questions:', error);
        }
    }

    function editQuestion(id) {
        currentEditTable = 'questions';
        currentEditId = id;
        fetch(`${API_BASE}/questions/${id}`).then(r => r.json()).then(q => {
            document.getElementById('editModalTitle').textContent = 'Edit Question';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Subject</label>
                    <select class="form-control" id="edit-q-subject">
                        <option value="math" ${q.subject === 'math' ? 'selected' : ''}>Math</option>
                        <option value="science" ${q.subject === 'science' ? 'selected' : ''}>Science</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-control" id="edit-q-category" value="${q.category}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Question</label>
                    <textarea class="form-control" id="edit-q-question" rows="3">${q.question}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Answer</label>
                    <textarea class="form-control" id="edit-q-answer" rows="2">${q.answer}</textarea>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    }

    async function deleteQuestion(id) {
        if (!confirm('Are you sure you want to delete this question?')) return;
        try {
            await fetch(`${API_BASE}/questions/${id}`, { method: 'DELETE' });
            loadQuestions();
        } catch (error) {
            alert('Error deleting question');
        }
    }

    // ========== Leaderboard ==========
    async function loadLeaderboard() {
        try {
            const response = await fetch(`${API_BASE}/leaderboard`);
            const data = await response.json();
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = data.map((entry, index) => `
                <tr id="leaderboard-${entry.id}">
                    <td>${index + 1}</td>
                    <td>${entry.id}</td>
                    <td>${entry.uid}</td>
                    <td>${entry.playerName}</td>
                    <td>${entry.score}</td>
                    <td>${entry.correctAnswers}</td>
                    <td>${entry.timestamp || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editLeaderboardEntry(${entry.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLeaderboardEntry(${entry.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            $('#leaderboardTable').DataTable();
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }

    function editLeaderboardEntry(id) {
        currentEditTable = 'leaderboard';
        currentEditId = id;
        fetch(`${API_BASE}/leaderboard/${id}`).then(r => r.json()).then(entry => {
            document.getElementById('editModalTitle').textContent = 'Edit Leaderboard Entry';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label class="form-label">UID</label>
                    <input type="text" class="form-control" id="edit-lb-uid" value="${entry.uid}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Player Name</label>
                    <input type="text" class="form-control" id="edit-lb-name" value="${entry.playerName}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Score</label>
                    <input type="number" class="form-control" id="edit-lb-score" value="${entry.score}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Correct Answers</label>
                    <input type="number" class="form-control" id="edit-lb-correct" value="${entry.correctAnswers}">
                </div>
            `;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    }

    async function deleteLeaderboardEntry(id) {
        if (!confirm('Are you sure you want to delete this leaderboard entry?')) return;
        try {
            await fetch(`${API_BASE}/leaderboard/${id}`, { method: 'DELETE' });
            loadLeaderboard();
        } catch (error) {
            alert('Error deleting leaderboard entry');
        }
    }

    // ========== Submodule Feedback ==========
    async function loadSubmoduleFeedback() {
        try {
            // Load stats
            const statsResponse = await fetch(`${API_BASE}/submodule-feedback/stats`);
            const stats = await statsResponse.json();
            document.getElementById('feedbackStats').textContent =
                `(${stats.total_count} total | Avg Rating: ${stats.average_rating}/5 | Sub2: ${stats.submodule2_count} | Sub3: ${stats.submodule3_count})`;

            // Load feedback entries
            const response = await fetch(`${API_BASE}/submodule-feedback`);
            const data = await response.json();
            const tbody = document.getElementById('submoduleFeedbackBody');
            tbody.innerHTML = data.map(entry => `
                <tr id="feedback-${entry.id}">
                    <td>${entry.id}</td>
                    <td>${entry.username}</td>
                    <td>${'⭐'.repeat(entry.rating)}</td>
                    <td><span class="badge ${entry.category === 'submodule2' ? 'bg-primary' : 'bg-success'}">${entry.category}</span></td>
                    <td title="${entry.comments || ''}">${(entry.comments || 'No comments').substring(0, 50)}${entry.comments && entry.comments.length > 50 ? '...' : ''}</td>
                    <td>${entry.timestamp || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editSubmoduleFeedback(${entry.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmoduleFeedback(${entry.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            $('#submoduleFeedbackTable').DataTable();
        } catch (error) {
            console.error('Error loading submodule feedback:', error);
        }
    }

    function editSubmoduleFeedback(id) {
        currentEditTable = 'submodule-feedback';
        currentEditId = id;
        fetch(`${API_BASE}/submodule-feedback/${id}`).then(r => r.json()).then(entry => {
            document.getElementById('editModalTitle').textContent = 'Edit Submodule Feedback';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="edit-fb-username" value="${entry.username}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Rating (1-5)</label>
                    <select class="form-control" id="edit-fb-rating">
                        ${[1,2,3,4,5].map(r => `<option value="${r}" ${entry.rating === r ? 'selected' : ''}>${r} - ${'⭐'.repeat(r)}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="edit-fb-category">
                        <option value="submodule2" ${entry.category === 'submodule2' ? 'selected' : ''}>Submodule 2</option>
                        <option value="submodule3" ${entry.category === 'submodule3' ? 'selected' : ''}>Submodule 3</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Comments</label>
                    <textarea class="form-control" id="edit-fb-comments" rows="3">${entry.comments || ''}</textarea>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    }

    async function deleteSubmoduleFeedback(id) {
        if (!confirm('Are you sure you want to delete this feedback entry?')) return;
        try {
            await fetch(`${API_BASE}/submodule-feedback/${id}`, { method: 'DELETE' });
            loadSubmoduleFeedback();
        } catch (error) {
            alert('Error deleting feedback entry');
        }
    }

    // ========== Badges ==========
    async function loadBadges() {
        try {
            const [respBadges, respMappings] = await Promise.all([
                fetch(`${API_BASE}/badges`),
                fetch(`${API_BASE}/user-badges?limit=1000`)
            ]);
            const badges = await respBadges.json();
            const mappings = await respMappings.json();

            // Map badge_id -> list of usernames/uids
            const usersByBadge = {};
            mappings.forEach(m => {
                usersByBadge[m.badge_id] = usersByBadge[m.badge_id] || [];
                usersByBadge[m.badge_id].push(m.username || m.uid || m.user_id);
            });

            const tbody = document.getElementById('badgesBody');
            tbody.innerHTML = badges.map(b => {
                const users = (usersByBadge[b.id] || []).map(u => `<span class="badge bg-info text-dark me-1">${u}</span>`).join(' ');
                return `
                <tr id="badge-${b.id}">
                    <td>${b.id}</td>
                    <td>${b.name}</td>
                    <td title="${b.description}">${b.description ? b.description.substring(0,80) : ''}${b.description && b.description.length > 80 ? '...' : ''}</td>
                    <td>${b.requirement}</td>
                    <td title="${b.image_url}">${b.image_url ? b.image_url.substring(0,60) : ''}</td>
                    <td>${users}</td>
                </tr>`;
            }).join('');

            if ($.fn.DataTable.isDataTable('#badgesTable')) {
                $('#badgesTable').DataTable().destroy();
            }
            $('#badgesTable').DataTable();
        } catch (error) {
            console.error('Error loading badges:', error);
        }
    }

    // ========== User Badges (pivot by user) ==========
    async function loadUserBadges() {
        try {
            const response = await fetch(`${API_BASE}/user-badges?limit=1000`);
            const data = await response.json();
            // group by user_id (fallback to uid)
            const grouped = {};
            data.forEach(ub => {
                const key = ub.user_id || ub.uid || ub.user;
                grouped[key] = grouped[key] || { user_id: ub.user_id, uid: ub.uid, username: ub.username, badges: []};
                grouped[key].badges.push({ badge_id: ub.badge_id, badge_name: ub.badge_name, awarded_at: ub.awarded_at });
            });

            const tbody = document.getElementById('userBadgesBody');
            tbody.innerHTML = Object.values(grouped).map(u => {
                const badgeHtml = u.badges.map(b => `<span class="badge bg-info text-dark me-1">${b.badge_id} <a href="#" class="text-danger ms-1" onclick="revokeBadge('${u.uid}','${b.badge_id}')" title="Revoke">&times;</a></span>`).join(' ');
                return `
                <tr id="user-badges-${u.user_id}">
                    <td>${u.user_id || ''}</td>
                    <td>${u.uid || ''}</td>
                    <td>${u.username || ''}</td>
                    <td>${badgeHtml}</td>
                    <td></td>
                </tr>`;
            }).join('');

            if ($.fn.DataTable.isDataTable('#userBadgesTable')) {
                $('#userBadgesTable').DataTable().destroy();
            }
            $('#userBadgesTable').DataTable();
        } catch (error) {
            console.error('Error loading user badges:', error);
        }
    }

    async function grantBadge() {
        const uid = document.getElementById('grant-uid').value.trim();
        const badgeId = document.getElementById('grant-badge-id').value.trim();
        if (!uid || !badgeId) {
            alert('Both UID and Badge ID are required');
            return;
        }
        try {
            const resp = await fetch(`${API_BASE}/user-badges`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: uid, badge_id: badgeId })
            });
            const data = await resp.json();
            if (resp.ok) {
                alert('Badge granted successfully');
                loadUserBadges();
            } else {
                alert('Error: ' + (data.error || JSON.stringify(data)));
            }
        } catch (e) {
            alert('Error granting badge: ' + e);
        }
    }

    async function revokeBadge(uid, badgeId) {
        if (!confirm(`Revoke badge ${badgeId} from ${uid}?`)) return;
        try {
            const resp = await fetch(`${API_BASE}/user-badges`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: uid, badge_id: badgeId })
            });
            const data = await resp.json();
            if (resp.ok) {
                alert('Badge revoked');
                loadUserBadges();
            } else {
                alert('Error: ' + (data.error || JSON.stringify(data)));
            }
        } catch (e) {
            alert('Error revoking badge: ' + e);
        }
    }

    // ========== Save Edit Handler ==========
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
        let endpoint = '';
        let body = {};
        let method = 'PUT';

        switch(currentEditTable) {
            case 'survey-responses':
                endpoint = `${API_BASE}/survey-responses/${currentEditId}`;
                body = {
                    uses_ai_schoolwork: document.getElementById('edit-uses-ai').value,
                    policy_perspective: document.getElementById('edit-policy').value,
                    badge_awarded: document.getElementById('edit-badge').value === 'true'
                };
                break;
            case 'ai-preferences-grouped':
                endpoint = `${API_BASE}/ai-preferences-by-user/${currentEditId}`;
                body = {
                    math: document.getElementById('edit-pref-math').value,
                    english: document.getElementById('edit-pref-english').value,
                    science: document.getElementById('edit-pref-science').value,
                    cs: document.getElementById('edit-pref-cs').value,
                    history: document.getElementById('edit-pref-history').value
                };
                break;
            case 'questions':
                endpoint = `${API_BASE}/questions/${currentEditId}`;
                body = {
                    subject: document.getElementById('edit-q-subject').value,
                    category: document.getElementById('edit-q-category').value,
                    question: document.getElementById('edit-q-question').value,
                    answer: document.getElementById('edit-q-answer').value
                };
                break;
            case 'leaderboard':
                endpoint = `${API_BASE}/leaderboard/${currentEditId}`;
                body = {
                    uid: document.getElementById('edit-lb-uid').value,
                    playerName: document.getElementById('edit-lb-name').value,
                    score: parseInt(document.getElementById('edit-lb-score').value),
                    correctAnswers: parseInt(document.getElementById('edit-lb-correct').value)
                };
                break;
            case 'submodule-feedback':
                endpoint = `${API_BASE}/submodule-feedback/${currentEditId}`;
                body = {
                    username: document.getElementById('edit-fb-username').value,
                    rating: parseInt(document.getElementById('edit-fb-rating').value),
                    category: document.getElementById('edit-fb-category').value,
                    comments: document.getElementById('edit-fb-comments').value
                };
                break;
        }

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                // Reload the appropriate table
                switch(currentEditTable) {
                    case 'survey-responses': loadSurveyResponses(); break;
                    case 'ai-preferences-grouped': loadAIPreferences(); break;
                    case 'questions': loadQuestions(); break;
                    case 'leaderboard': loadLeaderboard(); break;
                    case 'submodule-feedback': loadSubmoduleFeedback(); break;
                }
            } else {
                alert('Error saving changes');
            }
        } catch (error) {
            alert('Error saving changes: ' + error.message);
        }
    });
</script>

{% endblock %}

{% block background %}
{% endblock %}
